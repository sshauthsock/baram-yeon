<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON ì—…ë¡œë“œ ë° ìˆ˜ì •</title>
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="firebaseHelper.css">

    <script src="/assets/js/firebaseConfig.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<div class="header-container">
    <div class="header">
        <h1>Firebase Helper</h1>
        <div class="user-info">
            <span id="userDisplayName"></span>
            <button id="logoutButton" class="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</div>

<script>
    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ë° ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function checkFirebase() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged(function (user) {
                    if (user) {
                        // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                        document.getElementById('userDisplayName').textContent = user.displayName || user.email;
                    }
                });

                // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('logoutButton').addEventListener('click', function () {
                    firebase.auth().signOut().then(function () {
                        // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = 'login.html';
                    }).catch(function (error) {
                        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                        alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
                });
            } else {
                setTimeout(checkFirebase, 100);
            }
        }, 100);
    });
</script>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Firebase ì´ˆê¸°í™” ì¤‘...</h3>
            <p>í˜ì´ì§€ ë¡œë”©ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div id="loadingStatus" class="loading-status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
            <div class="progress-bar-container">
                <div id="loadingProgressBar" class="progress-bar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div id="connectionStatus"></div>

    <div class="tab-container">
        <div class="tab active" data-tab="document-manager">ë¬¸ì„œ ê´€ë¦¬</div>
        <div class="tab" data-tab="document-browser">ë¬¸ì„œ ëª©ë¡ ë³´ê¸°</div>
        <div class="tab" data-tab="stat-updater">ìŠ¤íƒ¯ ì¼ê´„ ì—…ë°ì´íŠ¸</div>
        <div class="tab" data-tab="new-guardian">ìƒˆ í™˜ìˆ˜ ì¶”ê°€</div>
    </div>

    <div id="document-manager" class="tab-content active">
        <div class="container">
            <h1>JSON íŒŒì¼ Firestoreì— ì—…ë¡œë“œ/ìˆ˜ì •</h1>

            <div class="form-group">
                <label for="documentName">ë¬¸ì„œ ì´ë¦„:</label>
                <input type="text" id="documentName" placeholder="ë¬¸ì„œ ì´ë¦„">
                <button onclick="FirestoreManager.checkDocument()" class="button-primary">ë¬¸ì„œ í™•ì¸</button>
            </div>

            <div id="documentInfo" class="info" style="display:none; margin-top: 10px;"></div>
            <div id="documentPreview" class="document-preview" style="display:none;"></div>

            <div class="radio-group">
                <label><input type="radio" name="uploadMode" value="create" checked> ìƒˆ ë¬¸ì„œ ìƒì„±</label>
                <label><input type="radio" name="uploadMode" value="overwrite"> ë¬¸ì„œ ë®ì–´ì“°ê¸°</label>
                <label><input type="radio" name="uploadMode" value="merge"> ë¬¸ì„œ ë³‘í•©</label>
                <label><input type="radio" name="uploadMode" value="update"> íŠ¹ì • í•„ë“œë§Œ ì—…ë°ì´íŠ¸</label>
            </div>

            <div class="form-group">
                <label for="jsonFileInput">JSON íŒŒì¼:</label>
                <input type="file" id="jsonFileInput" accept=".json">
            </div>

            <div id="updateFieldsContainer" class="form-group" style="display:none;">
                <label for="updateFields">ì—…ë°ì´íŠ¸í•  í•„ë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„):</label>
                <input type="text" id="updateFields" placeholder="ì˜ˆ: field1,field2.subfield,field3">
            </div>

            <div class="action-buttons">
                <button onclick="FirestoreManager.uploadJson()" class="button-primary">ì—…ë¡œë“œ</button>
                <button onclick="FirestoreManager.refreshDocumentList()" class="button-secondary">ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div id="status"></div>
        </div>
    </div>

    <div id="document-browser" class="tab-content">
        <div class="container">
            <h1>Firestore ë¬¸ì„œ ëª©ë¡</h1>

            <div class="document-browser-controls">
                <div class="search-container">
                    <input type="text" id="documentSearchInput" placeholder="ë¬¸ì„œ ê²€ìƒ‰..." class="search-input">
                    <select id="documentTypeFilter" class="filter-select">
                        <option value="">ëª¨ë“  ë¬¸ì„œ ìœ í˜•</option>
                        <option value="guardian">ìˆ˜í˜¸ í™˜ìˆ˜</option>
                        <option value="ride">íƒ‘ìŠ¹ í™˜ìˆ˜</option>
                        <option value="transform">ë³€ì‹  í™˜ìˆ˜</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <button onclick="FirestoreManager.refreshDocumentList()" class="refresh-button">
                    <span class="refresh-icon">â†»</span> ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>

            <div class="grid-container">
                <div class="document-list-section">
                    <div class="section-header">
                        <h3>ë¬¸ì„œ ëª©ë¡ <span id="documentCount" class="document-count">(0)</span></h3>
                    </div>
                    <div id="documentList" class="document-list">
                        <p class="loading-message">ë¬¸ì„œë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                    <div class="info document-info-tip">
                        ë¬¸ì„œë¥¼ í´ë¦­í•˜ë©´ ì˜¤ë¥¸ìª½ì— ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="document-content-section">
                    <div class="document-header">
                        <h3>ë¬¸ì„œ ë‚´ìš©</h3>
                        <div class="document-toolbar" id="documentToolbar" style="display: none;">
                            <button id="editSelectedDocBtn" onclick="FirestoreManager.prepareEditSelectedDocument()"
                                title="ë¬¸ì„œ í¸ì§‘" class="button-icon">
                                <span class="btn-icon">âœï¸</span> í¸ì§‘
                            </button>
                            <button id="downloadSelectedDocBtn" onclick="FirestoreManager.downloadDocument()"
                                title="ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ" class="button-icon">
                                <span class="btn-icon">â¬‡ï¸</span> ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button id="copySelectedDocBtn" onclick="FirestoreManager.copyDocumentToClipboard()"
                                title="í´ë¦½ë³´ë“œì— ë³µì‚¬" class="button-icon">
                                <span class="btn-icon">ğŸ“‹</span> ë³µì‚¬
                            </button>
                            <button id="deleteSelectedDocBtn" onclick="FirestoreManager.deleteSelectedDocument()"
                                class="delete-button button-icon" title="ë¬¸ì„œ ì‚­ì œ">
                                <span class="btn-icon">ğŸ—‘ï¸</span> ì‚­ì œ
                            </button>
                        </div>
                    </div>

                    <div id="selectedDocument" class="document-preview">
                        <p class="select-message">ë¬¸ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    </div>

                    <div id="jsonEditorContainer" class="json-editor-container">
                        <div class="edit-mode-tabs">
                            <div class="edit-mode-tab active" onclick="FirestoreManager.switchEditMode('json')">
                                <span class="tab-icon">{ }</span> JSON ì§ì ‘ í¸ì§‘
                            </div>
                            <div class="edit-mode-tab" onclick="FirestoreManager.switchEditMode('array')">
                                <span class="tab-icon">â‰¡</span> ë°°ì—´ ìˆœì„œ ë³€ê²½
                            </div>
                            <div class="edit-mode-tab" onclick="FirestoreManager.switchEditMode('data')">
                                <span class="tab-icon">ğŸ“Š</span> ë°ì´í„° í¸ì§‘
                            </div>
                        </div>

                        <div id="jsonEditMode" class="edit-mode-content">
                            <div class="editor-toolbar">
                                <button onclick="FirestoreManager.formatJson()" title="JSON í¬ë§·íŒ…" class="button-icon">
                                    <span class="btn-icon">ğŸ”§</span> í¬ë§·íŒ…
                                </button>
                                <span class="editor-info">ë‹¨ì¶•í‚¤: Ctrl+S = ì €ì¥, Ctrl+F = í¬ë§·íŒ…</span>
                            </div>
                            <textarea id="jsonEditor" spellcheck="false"></textarea>
                            <div class="editor-buttons">
                                <button onclick="FirestoreManager.saveJsonChanges()" class="primary save-button">
                                    <span class="btn-icon">ğŸ’¾</span> ë³€ê²½ ë‚´ìš© ì €ì¥
                                </button>
                                <button onclick="FirestoreManager.cancelEditing()" class="cancel-button">
                                    <span class="btn-icon">âŒ</span> í¸ì§‘ ì·¨ì†Œ
                                </button>
                            </div>
                        </div>

                        <div id="arrayEditMode" class="edit-mode-content" style="display:none;">
                            <div class="array-editor-header">
                                <h4>í•­ëª© ìˆœì„œ ë³€ê²½</h4>
                                <p>ì•„ë˜ í•­ëª©ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</p>
                            </div>
                            <div id="dataItemsContainer" class="data-items-container"></div>
                            <div class="editor-buttons">
                                <button onclick="FirestoreManager.saveArrayOrder()" class="primary save-button">
                                    <span class="btn-icon">ğŸ’¾</span> ìˆœì„œ ë³€ê²½ ì €ì¥
                                </button>
                                <button onclick="FirestoreManager.cancelEditing()" class="cancel-button">
                                    <span class="btn-icon">âŒ</span> í¸ì§‘ ì·¨ì†Œ
                                </button>
                            </div>
                        </div>

                        <div id="dataEditMode" class="edit-mode-content" style="display:none;">
                            <div class="data-edit-container">
                                <div class="guardian-list-container">
                                    <div class="list-toolbar">
                                        <h4>í™˜ìˆ˜ ëª©ë¡</h4>
                                        <input type="text" id="guardianSearchInput" placeholder="í™˜ìˆ˜ ê²€ìƒ‰..."
                                            class="search-input">
                                    </div>
                                    <div id="guardiansList" class="guardians-list"></div>
                                </div>
                                <div class="guardian-stats-container">
                                    <div class="stats-header">
                                        <h4>ë ˆë²¨ë³„ ìŠ¤íƒ¯</h4>
                                        <span id="selectedGuardianName" class="selected-guardian-label"></span>
                                    </div>
                                    <div id="levelTabsContainer" class="level-tabs-wrapper" style="display:none;">
                                        <div class="level-nav">
                                            <button onclick="FirestoreManager.goToPreviousLevel()" class="nav-button">
                                                <span class="btn-icon">â—€</span> ì´ì „ ë ˆë²¨
                                            </button>
                                            <button onclick="FirestoreManager.goToNextLevel()" class="nav-button">
                                                ë‹¤ìŒ ë ˆë²¨ <span class="btn-icon">â–¶</span>
                                            </button>
                                            <button onclick="FirestoreManager.copyPreviousLevelStats()"
                                                class="copy-button">
                                                <span class="btn-icon">ğŸ“‹</span> ì´ì „ ë ˆë²¨ ë³µì‚¬
                                            </button>
                                        </div>
                                        <div class="level-tabs"></div>
                                        <div class="level-content-container"></div>
                                        <div class="stat-actions">
                                            <h4>ëŠ¥ë ¥ì¹˜ ì¶”ê°€</h4>
                                            <div class="stat-add-form">
                                                <select id="statSearchDropdown" class="stat-dropdown">
                                                    <option value="">-- ì¶”ê°€í•  ëŠ¥ë ¥ì¹˜ ì„ íƒ --</option>
                                                </select>
                                                <button onclick="FirestoreManager.addSelectedStat()" class="add-button">
                                                    <span class="btn-icon">+</span> ì¶”ê°€
                                                </button>
                                            </div>
                                            <div id="selectedStatsContainer" class="selected-stats-container"></div>
                                        </div>
                                    </div>
                                    <div id="guardianInfoContainer" class="guardian-info-container">
                                        <p class="select-message">í™˜ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="editor-buttons data-editor-buttons">
                                <button onclick="FirestoreManager.saveDataChanges()" class="primary save-button">
                                    <span class="btn-icon">ğŸ’¾</span> ìŠ¤íƒ¯ ë³€ê²½ ì €ì¥
                                </button>
                                <button onclick="FirestoreManager.cancelEditing()" class="cancel-button">
                                    <span class="btn-icon">âŒ</span> í¸ì§‘ ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stat-updater" class="tab-content">
        <div class="container">
            <h1>ìŠ¤íƒ¯ ì •ë³´ ì¼ê´„ ì—…ë°ì´íŠ¸</h1>

            <div class="form-group">
                <label for="documentSelect">ëŒ€ìƒ ë¬¸ì„œ ì„ íƒ:</label>
                <select id="documentSelect">
                    <option value="">ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="guardian-bind-stats.json">guardian-bind-stats</option>
                    <option value="guardian-registration-stats.json">guardian-registration-stats</option>
                    <option value="ride-bind-stats.json">ride-bind-stats</option>
                    <option value="ride-registration-stats.json">ride-registration-stats</option>
                    <option value="transform-bind-stats.json">transform-bind-stats</option>
                    <option value="transform-registration-stats.json">transform-registration-stats</option>
                </select>
            </div>

            <div class="form-group">
                <label for="statInput">ìŠ¤íƒ¯ ì •ë³´ ì…ë ¥:</label>
                <textarea id="statInput" rows="8" placeholder="ì˜ˆì‹œ í˜•ì‹:
í™”ë¦° ê¸ˆì‚¬
25 ë ˆë²¨ ê²½í—˜ì¹˜ íšë“ì¦ê°€ 13 í”¼í•´ì €í•­ 64 ëŒ€ì¸í”¼í•´% 3 ëŒ€ì¸ë°©ì–´% 3 ì²´ë ¥íšŒë³µí–¥ìƒ 11 ë§ˆë ¥íšŒë³µí–¥ìƒ 11"></textarea>
            </div>

            <div class="action-buttons">
                <button onclick="FirestoreManager.previewParsing()" class="button-secondary">ìŠ¤íƒ¯ íŒŒì‹± ë¯¸ë¦¬ë³´ê¸°</button>
                <button onclick="FirestoreManager.updateStats()" class="button-secondary">ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸</button>
                <button onclick="FirestoreManager.previewStatsSeries()" class="button-secondary">ë ˆë²¨ë³„ ìŠ¤íƒ¯ ë¯¸ë¦¬ë³´ê¸°</button>
                <button onclick="FirestoreManager.updateStatsSeries()" class="button-primary">ë ˆë²¨ë³„ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸</button>
                <button onclick="FirestoreManager.clearStatInput()" class="button-secondary">ì…ë ¥ ì§€ìš°ê¸°</button>
            </div>

            <div id="parsingPreview" class="parsing-preview" style="display: none;"></div>
            <div id="statUpdateStatus" class="info" style="margin-top: 15px; display: none;"></div>
            <div id="updateResults" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="new-guardian" class="tab-content">
        <div class="container">
            <h1>ìƒˆë¡œìš´ í™˜ìˆ˜ ì¶”ê°€</h1>

            <div class="form-grid">
                <div class="form-group">
                    <label for="newGuardianDocumentSelect">ëŒ€ìƒ ë¬¸ì„œ ì„ íƒ:</label>
                    <select id="newGuardianDocumentSelect">
                        <option value="">ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="guardian-bind-stats.json">guardian-bind-stats</option>
                        <option value="guardian-registration-stats.json">guardian-registration-stats</option>
                        <option value="ride-bind-stats.json">ride-bind-stats</option>
                        <option value="ride-registration-stats.json">ride-registration-stats</option>
                        <option value="transform-bind-stats.json">transform-bind-stats</option>
                        <option value="transform-registration-stats.json">transform-registration-stats</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="newGuardianName">í™˜ìˆ˜ ì´ë¦„:</label>
                    <input type="text" id="newGuardianName" placeholder="ì˜ˆ: í™”ìš´ ê¸ˆë¼ì§€">
                </div>

                <div class="form-group">
                    <label for="newGuardianImage">ì´ë¯¸ì§€ ê²½ë¡œ:</label>
                    <input type="text" id="newGuardianImage">
                </div>

                <div class="form-group">
                    <label for="newGuardianInfluence">ì„¸ë ¥:</label>
                    <select id="newGuardianInfluence">
                        <option value="-">-</option>
                        <option value="ê²°ì˜">ê²°ì˜</option>
                        <option value="ê³ ìš”">ê³ ìš”</option>
                        <option value="ì¹¨ì°©">ì¹¨ì°©</option>
                        <option value="ì˜ì§€">ì˜ì§€</option>
                        <option value="í™œë ¥">í™œë ¥</option>
                        <option value="ëƒ‰ì •">ëƒ‰ì •</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="newGuardianType">í™˜ìˆ˜ íƒ€ì…:</label>
                    <select id="newGuardianType">
                        <option value="ìˆ˜í˜¸">ìˆ˜í˜¸</option>
                        <option value="íƒ‘ìŠ¹">íƒ‘ìŠ¹</option>
                        <option value="ë³€ì‹ ">ë³€ì‹ </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="newGuardianGrade">í™˜ìˆ˜ ë“±ê¸‰:</label>
                    <select id="newGuardianGrade">
                        <option value="ì „ì„¤">ì „ì„¤</option>
                        <option value="ë¶ˆë©¸">ë¶ˆë©¸</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="FirestoreManager.previewNewGuardian()" class="button-primary">í™˜ìˆ˜ ì¶”ê°€ ë¯¸ë¦¬ë³´ê¸°</button>
                <button onclick="FirestoreManager.addNewGuardian()" class="button-secondary">í™˜ìˆ˜ ì¶”ê°€í•˜ê¸°</button>
                <button onclick="FirestoreManager.clearNewGuardianForm()" class="button-secondary">ì–‘ì‹ ì´ˆê¸°í™”</button>
            </div>

            <div id="newGuardianJsonPreview" class="document-preview" style="display: none;"></div>
            <div id="newGuardianStatus" class="info" style="margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script src="/assets/js/common.js"></script>
    <script src="firebaseHelper.js"></script>
    <script>
        // ì¸ì¦ ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', function () {
            // Firebaseê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤
            setTimeout(function checkFirebase() {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().onAuthStateChanged(function (user) {
                        if (!user) {
                            // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜
                            window.location.href = 'login.html';
                        }
                    });
                } else {
                    // Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¬ì‹œë„
                    setTimeout(checkFirebase, 100);
                }
            }, 100);
        });
    </script>

</body>

</html>